@inherits LayoutComponentBase
@inject IThemeService _themeProvider
@inject IApplicationStateService _state
@inject IStorageService _storage
@inject IAppNavigationService _navigationManager;
@inject IAuthenticationService _authProvider;

<MudThemeProvider IsDarkMode="@_themeProvider.IsDarkTheme" DefaultScrollbar="false" />
<MudThemeProvider/>
<MudPopoverProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar>
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
    </MudAppBar>
    <MudDrawer @bind-Open="@_drawerOpen" Variant="@DrawerVariant.Mini" OpenMiniOnHover="true">
        <NavMenu/>
    </MudDrawer>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    CancellationTokenSource _cts = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _state.OnChange += StateHasChanged;
        var isDarkTheme = await _storage.GetValue<bool>(StorageKeys.DarkTheme);
        await _themeProvider.SetDarkTheme(isDarkTheme);

        var result = await _authProvider.IsAuthenticated(_cts.Token);
        if (!result)
        {
            _navigationManager.NavigateTo("/login");
            return;
        }

        if (result?.Data?.CompanyId is null)
            _navigationManager.NavigateTo("/select-company");

    }
}