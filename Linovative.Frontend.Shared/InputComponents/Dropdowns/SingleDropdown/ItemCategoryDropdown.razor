@using LinoVative.Shared.Dto.ItemDtos
@using Linovative.Frontend.Services.FrontendServices
@using MapsterMapper
@inherits SearchableDropdownBase<ItemCategoryDto>

@inject IItemCategoryService _service
@inject IApplicationStateService _state
@inject IMapper _mapper;

<SearchableDropdown Required=@Required
                    RequiredMessage=@RequiredMessage
                    Immediate=false
                    Label=@_label
                    Value=@Value
                    Text=@Text
                    TextChanged="@(x => Text = x)"
                    ValueChanged=@ValueChanged
                    StringConvert="@((x) => $"{x.Name}")"
                    PageSize=@PageSize
                    Clearable="@Clearable"
                    TItem="ItemCategoryDto"
                    Disabled="@Disabled"
                    ErrorKey="@ErrorKey"
                    LocalizerResource="@LocalizerResource"
                    LocalizerKey="@LocalizerKey"
                    Error="@Error"
                    Errors="@Errors"
                    ErrorMessage="@ErrorMessage"
                    SearchFunction="LoadData" />

@code {
    private CancellationTokenSource cts { get; set; } = new();
    protected override async Task OnInitializedAsync()
    {
        _state.OnChange += StateHasChanged;
        await base.OnInitializedAsync();
        PageSize = PageSize == 0 ? 10 : PageSize;
        
    }

    string? _label => !string.IsNullOrEmpty(Label) ? Label : this.JsonLocalizer[$"{LocalizerResource}.{LocalizerKey}.Label"];


    async Task<Response<List<ItemCategoryDto>>> LoadData(string? keyword, int page)
    {
        var odataFilter = new ODataFilter()
            {
                PageNumber = page,
                PageSize = PageSize,
                SortDirection = ShortDirections.Asc,
                OrderFiled = nameof(ItemCategoryDto.Name),
                FilterPayload = new { searchkeyword = keyword }
            };

        var result = await _service.Get(odataFilter, cts.Token);
        if (!result) return new();

        return Response<List<ItemCategoryDto>>.Ok(result.Data!.Select(x => _mapper.Map<ItemCategoryDto>(x)).ToList());
    }

}
