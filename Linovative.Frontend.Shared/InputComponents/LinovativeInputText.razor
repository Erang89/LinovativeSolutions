@inherits LinovativeInputComponentBase<string?>
@inject IApplicationStateService _state;

<MudTextField Value="@Value"
              ValueChanged="@ValueChange"
              Required="IsRequired"
              ReadOnly="ReadOnly"
              Label="@_label"
              Immediate="@Immediate"
              id="@Id"
              @onclick="@(async () => await OnClick.InvokeAsync())"
              T="string"
              InputType="InputType"
              Placeholder="@Placeholder"
              Disabled="@Disabled"
              Error="@_isError"
              ErrorText="@_errorMessage"
              RequiredError="@_requiredMessage"
              Style="@Style"
              Clearable="@Clearable"
              Variant="@variant"
              ClearIcon="@ClearIcon"
              IconSize="@IconSize"
              Adornment="@Adornment"
              Lines="@Lines"
              @ref="@input"
              OnClearButtonClick="@OnClearButtonClick"></MudTextField>

@code {
    MudBlazor.Variant variant => Variant.ToMudBlazorVariant();
    bool _isError => Error || _containErrors;
    bool _containErrors => (ErrorKey is not null && Errors is not null && Errors.Count() > 0 && Errors.ContainsKey(ErrorKey));
    string? _errorMessage => Error ? ErrorMessage : _containErrors ? string.Join(" ", getError()) : (IsRequired && string.IsNullOrEmpty(Value)) ? _requiredMessage : "";
    string? _label => !string.IsNullOrEmpty(Label) ? Label : string.IsNullOrWhiteSpace(LocalizerKey)? "" : this.JsonLocalizer[$"{LocalizerResource}.{LocalizerKey}.Label"];
    string? _requiredMessage => !string.IsNullOrWhiteSpace(RequiredMessage) ? RequiredMessage : this.JsonLocalizer[$"{LocalizerResource}.{LocalizerKey}.Required.ErrorMessage"];
    MudTextField<string?> input { get; set; } = null!;
    List<string> getError() => Errors is not null && !string.IsNullOrEmpty(ErrorKey) && Errors.ContainsKey(ErrorKey) ? Errors[ErrorKey] : new List<string>();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _state.OnChange += StateHasChanged;
        ErrorKey = ErrorKey ?? LocalizerKey;
    }

    public async Task Validate()
    {
        await input.Validate();
    }

    async Task ValueChange(string? value)
    {
        Value = value;
        await ValueChanged.InvokeAsync(value);
    }

    public async Task Focus()
    {
        await input.FocusAsync();
    }

    public async Task Blur()
    {
        await input.BlurAsync();
    }
}
