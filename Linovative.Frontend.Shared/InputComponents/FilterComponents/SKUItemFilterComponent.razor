@using System.Linq.Expressions
@using LinoVative.Shared.Dto.ItemDtos
@using Linovative.Frontend.Shared.InputComponents.Dropdowns.MultiSelect

@inject IApplicationStateService _state
@inject IJsonLocalizer _loc

<FilterComponent Title="@Label"
                 @ref=@filterComponent
                 ValueInputNameBased="@GenerateInputUi"
                 FieldValues="@FieldValues"
                 FieldSources="@selectedTypes"
                 OnClearFilter="@OnClearFilter"
                 OnFilterButtonClick="@OnFilterButtonClick"
                 FieldValuesChanged="@OnFieldValuesChanged"
                 AdditionalButton="@AdditionalButton"
                 HideFilterButton="@HideFilterButton" />


@code {

    [Parameter] public List<DataGridFilterModel> FieldValues { get; set; } = new();
    [Parameter] public EventCallback<List<DataGridFilterModel>> FieldValuesChanged { get; set; }
    [Parameter] public bool HideFilterButton { get; set; }
    [Parameter] public List<string> HideColumns { get; set; } = new();
    [Parameter] public List<string> OnlyShowColumns { get; set; } = new();
    [Parameter] public EventCallback OnFilterButtonClick { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public EventCallback OnClearFilter { get; set; }
    [Parameter] public RenderFragment? AdditionalButton { get; set; }

    FilterComponent? filterComponent { get; set; }
    public void AddNew() => filterComponent?.AddFieldValue();


    static Func<string, string> GetLable = (x) => "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _state.OnChange += StateHasChanged;
        await _loc.EnsureLoadedAsync($"{nameof(SKUItemFilterComponent)}", "Linovative.Frontend.Shared");
        GetLable = (string key) => _loc[$"{nameof(SKUItemFilterComponent)}.{key}.Label"];
        Label ??= GetLable("Title");

        types = new List<FilterComponent.FieldType>()
                    {
                        new(Columns.SKU, DataGridFilterModel.PropertyType.String, GetLable(Columns.SKU), GetLable(Columns.SKU)),
                        new(Columns.ItemName, DataGridFilterModel.PropertyType.String, GetLable(Columns.ItemName), GetLable(Columns.ItemName)),
                        new(Columns.Variant, DataGridFilterModel.PropertyType.String, GetLable(Columns.Variant), GetLable(Columns.Variant)),
                        new(Columns.CategoryName, DataGridFilterModel.PropertyType.String, GetLable(Columns.CategoryName), GetLable(Columns.CategoryName)),
                        new(Columns.UnitName, DataGridFilterModel.PropertyType.String, GetLable(Columns.UnitName), GetLable(Columns.UnitName)),
                        new(Columns.SalePrice, DataGridFilterModel.PropertyType.Decimal, GetLable(Columns.SalePrice), GetLable(Columns.SalePrice)),
                        new(Columns.IsActive, DataGridFilterModel.PropertyType.Boolean, GetLable(Columns.IsActive), GetLable(Columns.IsActive)),
                        new(Columns.IsPurchaseItem, DataGridFilterModel.PropertyType.Boolean, GetLable(Columns.IsPurchaseItem), GetLable(Columns.IsPurchaseItem)),
                        new(Columns.IsSaleItem, DataGridFilterModel.PropertyType.Boolean, GetLable(Columns.IsSaleItem), GetLable(Columns.IsSaleItem)),
                    };

        selectedTypes = types
        .Where(x => !HideColumns.Contains(x.FieldName))
        .Where(x => OnlyShowColumns.Count == 0 || OnlyShowColumns.Contains(x.FieldName))
        .ToList();
    }

    private async Task OnFieldValuesChanged(List<DataGridFilterModel> values)
    {
        FieldValues = values;
        await FieldValuesChanged.InvokeAsync(FieldValues);
    }


    public static class Columns
    {
        public const string SKU = nameof(SKUItemViewDto.SKU);
        public const string ItemName = $"{nameof(SKUItemViewDto.ItemName)}";
        public const string Variant = $"{nameof(SKUItemViewDto.VarianName)}";
        public const string CategoryName = $"{nameof(SKUItemViewDto.CategoryName)}";
        public const string UnitName = $"{nameof(SKUItemViewDto.UnitName)}";
        public const string SalePrice = $"{nameof(SKUItemViewDto.SalePrice)}";
        public const string IsActive = $"{nameof(SKUItemViewDto.IsActive)}";
        public const string IsPurchaseItem = $"{nameof(SKUItemViewDto.IsPurchaseItem)}";
        public const string IsSaleItem = $"{nameof(SKUItemViewDto.IsSaleItem)}";
    }


    List<FilterComponent.FieldType> types { get; set; } = new();
    List<FilterComponent.FieldType> selectedTypes { get; set; } = new();

    RenderFragment? GenerateInputUi(DataGridFilterModel model)
    {
        return model.Column switch
        {
            //Columns.ItemGroupNames => @<ItemGroupMultiSelect Label="@GetLable("Groups")" Placeholder="@GetLable("Groups")" OnChanged="@((x) => model.Value = x.Select(x => x.Id).ToList())" />,
            //Columns.ItemCategoryNames => @<ItemCategoryMultiSelect Label="@GetLable("Categories")" Placeholder="@GetLable("Categories")" OnChanged="@((x) => model.Value = x.Select(x => x.Id).ToList())" />,
            //Columns.ItemUnitNames => @<ItemUnitMultiSelect Label="@GetLable("Units")" Placeholder="@GetLable("Units")" OnChanged="@((x) => model.Value = x.Select(x => x.Id).ToList())" />,
            _ => null
        };
    }
}
