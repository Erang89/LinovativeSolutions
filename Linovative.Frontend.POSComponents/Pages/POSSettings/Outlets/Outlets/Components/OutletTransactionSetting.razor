@using LinoVative.Shared.Dto
@using LinoVative.Shared.Dto.MasterData.Payments
@using LinoVative.Shared.Dto.MasterData.Shifts
@using LinoVative.Shared.Dto.OrderTypes
@using LinoVative.Shared.Dto.Outlets
@using Linovative.Frontend.POSComponents.Bases
@using System.Threading.Tasks
@using Linovative.Frontend.Services.Models

@inherits POSManagementPageBase
@inject IPaymentMethodService _paymentMethodService
@inject IOrderTypeService _OrderTypeService
@inject IBankNoteService _bankNotesService
@inject IShiftService _shiftService

<MudGrid Spacing="20" Justify="Justify.SpaceBetween">

    <MudItem xs="12" sm="5" lg="4">
        <MudText Typo="Typo.h6">@Label("PaymentMethods")</MudText>
        <MudSimpleTable Style="overflow-x: auto;">
            <tbody>
                @foreach (var p in _paymentMethods)
                {
                    <tr>

                        <td style="min-width: 150px">
                            <div class="d-flex"><MudSwitch @bind-Value="@p.Value.IsActive" Label="@p.Key.Name" Color="Color.Info" /></div>
                        </td>


                        <td style="width: 100px">
                            <LinovativeInputGeneric Disabled="@(!p.Value.IsActive)" T="int"
                                                    Value="@p.Value.Sequence"
                                                    ValueChanged="@(x => p.Value.Sequence = x)"
                                                    IsRequired="true"
                                                    Style="width: 150px"
                                                    Errors="@Result?.Errors"
                                                    LocalizerResource="@LocalizerResource"
                                                    LocalizerKey="Sequence" />
                        </td>


                    </tr>
                }
            </tbody>
        </MudSimpleTable>

        <LinovativeGap />
        <MudText Typo="Typo.h6">@Label("BankNotes")</MudText>
        <MudSimpleTable Style="overflow-x: auto;">
            <tbody>
                @foreach (var p in _bankNotes)
                {
                    <tr>

                        <td style="min-width: 150px">
                            <div class="d-flex"><MudSwitch @bind-Value="@p.Value.IsActive" Label="@($"{p.Key.Note}")" Color="Color.Info" /></div>
                        </td>

                    </tr>
                }
            </tbody>
        </MudSimpleTable>

    </MudItem>

    <MudItem xs="12" sm="6" lg="7">
        <MudText Typo="Typo.h6">@Label("OrderTypes")</MudText>
        <MudSimpleTable Style="overflow-x: auto;">
            <tbody>
                @foreach (var ot in _orderTypes)
                {
                    <tr>

                        <td style="min-width: 200px">
                            <div class="d-flex"><MudSwitch @bind-Value="@ot.Value.IsActive" Label="@ot.Key.Name" Color="Color.Info" /></div>
                        </td>


                        <td style="width: 150px">
                            <LinovativeInputGeneric Disabled="@(!ot.Value.IsActive)"
                                                    T="decimal"
                                                    Value="@ot.Value.TaxPercent"
                                                    ValueChanged="@(x => ot.Value.TaxPercent = x)"
                                                    IsRequired="true"
                                                    Errors="@Result?.Errors"
                                                    Style="width: 150px"
                                                    LocalizerResource="@LocalizerResource"
                                                    LocalizerKey="TaxPercent" />
                        </td>



                        <td style="width: 150px">
                            <LinovativeInputGeneric T="decimal"
                                                    Disabled="@(!ot.Value.IsActive)"
                                                    Value="@ot.Value.ServicePercent"
                                                    ValueChanged="@(x => ot.Value.ServicePercent = x)"
                                                    IsRequired="true"
                                                    Errors="@Result?.Errors"
                                                    Style="width: 150px"
                                                    LocalizerResource="@LocalizerResource"
                                                    LocalizerKey="ServicePercent" />
                        </td>


                        <td style="width: 150px">
                            <LinovativeInputGeneric T="int"
                                                    Disabled="@(!ot.Value.IsActive)"
                                                    Value="@ot.Value.Sequence"
                                                    ValueChanged="@(x => ot.Value.Sequence = x)"
                                                    IsRequired="true"
                                                    Style="width: 150px"
                                                    Errors="@Result?.Errors"
                                                    LocalizerResource="@LocalizerResource"
                                                    LocalizerKey="Sequence" />
                        </td>


                    </tr>
                }
            </tbody>
        </MudSimpleTable>

    </MudItem>


</MudGrid>
@code {

    [Parameter] public OutletDto? Outlet { get; set; }
    [Parameter] public Response? Result { get; set; }

    protected override string LocalizerResource => nameof(OutletsPage);

    private List<KeyValuePair<PaymentMethodViewDto, OutletPaymentMethodDto>> _paymentMethods { get; set; } = new();
    private List<KeyValuePair<OrderTypeViewDto, OutletOrderTypeDto>> _orderTypes { get; set; } = new();
    private List<KeyValuePair<BankNoteDto, OutletBankNoteDto>> _bankNotes { get; set; } = new();
    private List<KeyValuePair<ShiftViewDto, OutletShiftDto>> _shift { get; set; } = new();
    private CancellationTokenSource cancellationTokenSource { get; set; } = new();


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadPaymentMethod();
    }


    async Task LoadPaymentMethod()
    {
        var paymentMethodTask = _paymentMethodService.GetAll(cancellationTokenSource.Token);
        var orderTypeTasks = _OrderTypeService.GetAll(cancellationTokenSource.Token);
        var bankNoteTask = _bankNotesService.GetAll(cancellationTokenSource.Token);
        var shiftTask = _shiftService.GetAll(cancellationTokenSource.Token);

        await Task.WhenAll(paymentMethodTask, orderTypeTasks, bankNoteTask, shiftTask);

        _paymentMethods = (await paymentMethodTask).Data!
        .Select(x => new KeyValuePair<PaymentMethodViewDto, OutletPaymentMethodDto>(x, Outlet?.PaymentMethods
            .FirstOrDefault(x => x.PaymentMethodId == x.Id) ?? CreateNewPaymentMethod())).ToList();

        _orderTypes = (await orderTypeTasks).Data!
        .Select(x => new KeyValuePair<OrderTypeViewDto, OutletOrderTypeDto>(x, Outlet?.OrderTypes
        .FirstOrDefault(x => x.OrderTypeId == x.Id) ?? CreateNewOrderType())).ToList();

        _bankNotes = (await bankNoteTask).Data!
        .Select(x => new KeyValuePair<BankNoteDto, OutletBankNoteDto>(x, Outlet?.BankNotes
        .FirstOrDefault(x => x.BankNoteId == x.Id) ?? new() { IsActive = false })).ToList();

        _shift = (await shiftTask).Data!
        .Select(x => new KeyValuePair<ShiftViewDto, OutletShiftDto>(x, Outlet?.Shifts
        .FirstOrDefault(x => x.ShiftId == x.Id) ?? CreateNewShift())).ToList();
    }


    OutletPaymentMethodDto CreateNewPaymentMethod()
    {
        var newPaymentMethod = new OutletPaymentMethodDto() { IsActive = true };
        Outlet.PaymentMethods.Add(newPaymentMethod);
        return newPaymentMethod;
    }

    OutletOrderTypeDto CreateNewOrderType()
    {
        var newOrderType = new OutletOrderTypeDto() { IsActive = true };
        Outlet.OrderTypes.Add(newOrderType);
        return newOrderType;
    }

    OutletShiftDto CreateNewShift()
    {
        var newShift = new OutletShiftDto() { IsActive = true };
        Outlet.Shifts.Add(newShift);
        return newShift;
    }

}
