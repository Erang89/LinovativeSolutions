@using Linovative.Frontend.POSComponents.Bases
@using Linovative.Frontend.Services.Models
@using Linovative.Frontend.Shared.InputComponents.Dropdowns.SingleDropdown
@using Linovative.Frontend.POSComponents.Pages.POSSettings.Outlets.Shared
@using LinoVative.Shared.Dto.Outlets

@attribute [Route(PageRoutes.PostManagement.PosSettings.Outlets.Table)]
@inherits POSManagementPageBase
@layout PosLayout

@inject IJsonLocalizer _loc
@inject ITopBarService _topBarService
@inject IApplicationStateService _state
@inject IOutletAreaService _service
@inject IDialogService _dialogService
@inject IMapper _mapper

<LinovativePageTitle Title="@EntityPluralName" />
<OutletBreadcrumb />
<OutletTabs SelectedTab="OutletTabs.Tabs.Tables" />
<LinovativeGap />

<LinovativeGap />
<MudGrid>
    <MudItem md="4">
        <MudText Typo="Typo.caption">@_loc[$"{LocalizerResource}.SelectTableDescription"]</MudText>
        <LinovativeGap />
        <OutletDropdown Label="Select Outlet" Immediate="true" Value="@selectedOutlet" ValueChanged="@( async (e) => await LoadArea(e))" />
    </MudItem>
</MudGrid>


@if (selectedOutlet is not null)
{
    <LinovativeGap />
    <MudButton EndIcon="@Icons.Material.Filled.Save"
               Color="Color.Primary"
               OnClick="@Save"
               Variant="@ComponentSettings.SaveButtonVariant">@_loc.Global("Button.Save")</MudButton>

    <LinovativeGap />
    <MudText Typo="Typo.h6">@selectedOutlet.Name?.ToUpper() -  @EntityPluralName</MudText>


    <AppErrorAlert @ref="@errorAlert" AutoClose="true" />
    <AppSuccessAllert @ref="@successAllert" AutoClose="true" />

    <LinovativeGap />
    <MudGrid>
        <LinovativeGap />
        <MudItem md="4" lg="2">
            <MudPaper>
                <MudList T="OutletAreaViewDto" @bind-SelectedValue="selectedArea" SelectionMode="@SelectionMode.SingleSelection" ReadOnly="true">
                    @foreach (var area in area.Data ?? new())
                    {
                        <MudListItem Class="show-on-hover" Value="area" OnClick="@(() => SelectAreaChange(area))">
                            <ChildContent>
                                <div class="d-flex align-content-space-between">
                                    <div>@area.Name</div> <MudSpacer />  <MudIcon Class="item-show-on-hover cursor-pointer" @onclick="@(() => DeleteArea(area))" Icon="@Icons.Material.Filled.Delete" />
                                </div>
                            </ChildContent>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>

            <LinovativeGap />
            <MudButton OnClick="@(() => SetValue(() =>
                    {
                        selectedArea = new OutletAreaViewDto(){ OutletId = selectedOutlet!.Id, Name = _loc[$"{LocalizerResource}.NewArea.Label"]};
                        area.Data!.Add(selectedArea);
                    }))"
                       IconSize="Size.Small"
                       EndIcon="@Icons.Material.Filled.Add"
                       Variant="Variant.Outlined">Add Area</MudButton>
        </MudItem>
        @if (selectedArea is not null)
        {
            var areaIndex = area.Data!.IndexOf(area.Data.FirstOrDefault(x => x.Id == selectedArea.Id)!);

            <MudItem md="8" lg="10">

                <MudForm @ref="form" @bind-IsValid="@isFormValid"
                         @bind-Errors="@formErrors"
                         @onkeypress="@(() => formErrorAlert?.HideAlert())">

                    <div class="d-flex flex-grow-1 gap-4">

                        <LinovativeInputText @bind-Value="@selectedArea.Name"
                                             IsRequired="true"
                                             Immediate="true"
                                             Class="flex-none"
                                             Style="min-width: 300px"
                                             ErrorKey="@($"{areaIndex}.Name")"
                                             Label="@_loc[$"{LocalizerResource}.Name.Label"]"
                                             Errors="@formResponse?.Errors" />


                        <LinovativeTextBox Value="@selectedArea.Sequence.ToString()"
                                           ValueChanged="@(x => selectedArea.Sequence = int.Parse(x))"
                                           InputType="InputType.Number"
                                           IsRequired="true"
                                           Immediate="true"
                                           Class="flex-none"
                                           Style="min-width: 100px"
                                           T="string"
                                           Label="@_loc[$"{LocalizerResource}.Sequence.Label"]"
                                           ErrorKey="@($"{areaIndex}.Sequence")" />

                        <MudSwitch Class="flex-none align-self-center"
                                   Label="@_loc.Global("Label.Active")"
                                   Value="@selectedArea.IsActive"
                                   T="bool"
                                   ValueChanged="@((e) => SetValue(() => selectedArea.IsActive = !selectedArea.IsActive))"
                                   Color="Color.Primary" />

                        <div class="flex-1"></div>
                    </div>


                    <LinovativeGap />
                    <MudSimpleTable Style="overflow-x: auto;">
                        <thead>
                            <tr>
                                <th>@_loc[$"{LocalizerResource}.TableName.Label"]</th>
                                <td width="200">@_loc[$"{LocalizerResource}.Status.Label"]</td>
                                <th width="120"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var table in selectedArea.Tables)
                            {
                                if (table == selectedTable)
                                {
                                    var tableIndex = selectedArea.Tables.IndexOf(table);
                                    <tr>
                                        <td>
                                            <LinovativeInputText @bind-Value="@table.Name"
                                                                 IsRequired="true"
                                                                 Immediate="true"
                                                                 Label="@_loc[$"{LocalizerResource}.TableName.Label"]"
                                                                 ErrorKey="@($"Table_{tableIndex}.Name")" />
                                        </td>
                                        <td>
                                            <MudSwitch Label="@_loc.Global("Label.Active")" Value="@table.IsActive" T="bool" ValueChanged="@((e) => SetValue(() => table.IsActive = !table.IsActive))" Color="Color.Primary" />
                                        </td>
                                        <td>
                                            <MudIcon Class="cursor-pointer" @onclick="@(() => SetValue(() => selectedTable = null))" Icon="@Icons.Material.Filled.Check" />
                                            <MudIcon Class="cursor-pointer ms-2" @onclick="@(() => DeleteTable(table))" Icon="@Icons.Material.Filled.Delete" />
                                        </td>
                                    </tr>
                                    continue;
                                }
                                <tr>
                                    <td>@table.Name</td>
                                    <td style="text-align: center">
                                        <MudBadge Origin="Origin.TopRight" Dot="true" Color="@(table.IsActive? Color.Primary : Color.Secondary)" Class="mx-6 my-4">
                                            <MudText>
                                                @(table.IsActive ? _loc.Global("Label.Active") : _loc.Global("Label.NotActive"))
                                            </MudText>
                                        </MudBadge>
                                    </td>
                                    <td>
                                        <MudIcon Class="cursor-pointer" @onclick="@(() => SetValue(() => selectedTable = table))" Icon="@Icons.Material.Filled.Edit" />
                                        <MudIcon Class="cursor-pointer ms-2" @onclick="@(() => DeleteTable(table))" Icon="@Icons.Material.Filled.Delete" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>

                    <LinovativeGap />
                    <div>
                        <MudButton OnClick="@(() => SetValue(() =>
                    {
                        selectedTable = new OutletTableViewDto(){ AreaId = selectedArea!.Id, Name = _loc[$"{LocalizerResource}.NewTable.Label"]};
                        selectedArea.Tables.Add(selectedTable);
                    }))"
                                   IconSize="Size.Small"
                                   EndIcon="@Icons.Material.Filled.Add"
                                   Variant="Variant.Outlined">@_loc[$"{LocalizerResource}.AddNewTable.Button"]</MudButton>
                    </div>
                </MudForm>
            </MudItem>
        }
    </MudGrid>
}

@code {

    protected override string LocalizerResource => nameof(TablesPage);
    protected override string EntityName => JsonLocalizer[$"{LocalizerResource}.Entity.Name.Single"];
    protected override string EntityPluralName => JsonLocalizer[$"{LocalizerResource}.Entity.Name.Plural"];


    private bool isFormValid { get; set; }
    private string[] formErrors { get; set; } = { };
    private MudForm? form { get; set; }
    private Response? formResponse { get; set; } = null;
    private bool isFormSubmitting { get; set; }
    private AppErrorAlert? formErrorAlert { get; set; }
    private AppSuccessAllert? successAllert { get; set; }
    private AppErrorAlert? errorAlert { get; set; }


    private Response<List<OutletAreaViewDto>> area = new() { Data = new() };
    private OutletAreaViewDto? selectedArea { get; set; }
    private OutletViewDto? selectedOutlet { get; set; }
    private List<OutletAreaViewDto> newAreas { get; set; } = new();
    private OutletTableViewDto? selectedTable { get; set; }
    public CancellationTokenSource cts { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _state.OnChange += StateHasChanged;
        await base.OnInitializedAsync();
        _topBarService.SetTitle(EntityPluralName);
    }

    async Task LoadArea(OutletViewDto? outlet)
    {

        selectedOutlet = outlet;
        selectedArea = null;

        if (outlet is not null)
        {
            area = await _service.Get(new ODataFilter() { Options = $"$filter=outletid eq ({outlet.Id})&$expand=tables" }, cts.Token);
            _state.NotifyStateChanged();
            selectedArea = area.Data?.FirstOrDefault();
            return;
        }

        _state.NotifyStateChanged();
    }

    async Task SelectAreaChange(OutletAreaViewDto? area)
    {
        selectedArea = area;
        await Task.CompletedTask;
        _state.NotifyStateChanged();
    }

    async Task DeleteTable(OutletTableViewDto table)
    {
        selectedArea!.Tables = selectedArea.Tables.Where(x => x != table).ToList();
        if (table == selectedTable)
        {
            selectedTable = null;
        }
        await Task.CompletedTask;
        _state.NotifyStateChanged();
    }

    async Task Save()
    {
        formResponse = await _service.Update(new { Areas = area.Data }, cts.Token);
        if (!formResponse)
        {
            errorAlert?.ShowAlert(formResponse);
            return;
        }

        successAllert?.ShowAlert(_loc[$"{LocalizerResource}.SaveSuccess.Alert.Text"]);
    }



    void SetValue(Action setAction)
    {
        setAction();
        _state.NotifyStateChanged();
    }

    void DeleteArea(OutletAreaViewDto areaDto)
    {
        if (areaDto == selectedArea)
        {
            selectedArea = null;
        }

        area.Data = area.Data!.Where(x => x != areaDto).ToList();
        _state.NotifyStateChanged();
    }
}
