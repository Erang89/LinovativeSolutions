@using LinoVative.Shared.Dto.MasterData.Customers
@using LinoVative.Shared.Dto.MasterData.Suppliers
@using Linovative.Frontend.POSComponents.Bases
@using Linovative.Frontend.POSComponents.Pages.POSManagements.Items.Customers.Shared
@using Linovative.Frontend.POSComponents.Pages.POSManagements.Items.Suppliers.Shared
@using Linovative.Frontend.Services.Models
@using Linovative.Frontend.Shared.Extensions
@using Linovative.Frontend.Shared.InputComponents.FilterComponents
@using Linovative.Shared.Interface.Enums

@attribute [Route(PageRoutes.PostManagement.Customers.Index)]
@inherits POSManagementPageBase
@layout PosLayout

@inject IJsonLocalizer _loc
@inject ITopBarService _topBarService
@inject IApplicationStateService _state
@inject ICustomerService _service
@inject IDialogService _dialogService
@inject IMapper _mapper
@inject IAppNavigationService _nav
@inject IGlobalMessage _globalMessage
@inject IOutletService _outletService


<LinovativePageTitle Title="@EntityPluralName" />
<CustomerBreadCrumb Childs="@(new() { })" />
<CustomerTabs SelectedTab="CustomerTabs.Tabs.Customer" />
<CrudButtons PageMode="PageModes.List"
             OnAddNew="@(() => _nav.NavigateTo(PageRoutes.PostManagement.Customers.CustomerAdd))"
             OnDelete="Delete"
             SelectedItemCount="@selectedItems.Count" IsFormSubmitting="isFormSubmitting">
    <MudBadge Class="ms-1" Content="@(filterFalues.Count)" Origin="Origin.BottomRight" Overlap="true">
        <MudButton Variant="Variant.Outlined" StartIcon="@(showFilter? Icons.Material.Filled.RemoveRedEye : Icons.Material.Outlined.RemoveRedEye)" OnClick="@TogleFilter">@(showFilter? @Label("HideFilter") : Label("ShowFilter"))</MudButton>
    </MudBadge>
</CrudButtons>
<LinovativeGap />

<AppSuccessAllert @ref="@successAllert" AutoClose="true" />
<AppErrorAlert @ref="@deleteAllert" AutoClose="true" />
<GlobalMessage AutoClose="true" />


<MudPaper class="@(showFilter ? "rounded-0 rounded-t" : "d-none")">
    <CustomerFilterComponent OnClearFilter="@ClearFilter" OnFilterButtonClick="@(() => table!.ReloadServerData())" FieldValues="@filterFalues" FieldValuesChanged="@(x => filterFalues = x)" @ref=@filterComponent Label="@Label("FilterCustomer")">
        <AdditionalButton>
            <MudButton Class="ms-2" Variant="Variant.Text" StartIcon="@Icons.Material.Outlined.Close" OnClick="@(() => showFilter = !showFilter)" Color="Color.Primary">@_loc.Global("Button.Close")</MudButton>
        </AdditionalButton>
    </CustomerFilterComponent>
</MudPaper>

<MudTable ServerData="ServerReload" Dense="false" Hover="true" @ref="@table">
    <ToolBarContent>
        <MudText Typo="Typo.h6">@EntityPluralName</MudText>
        <MudSpacer />
        <MudTextField T="string"
                      Immediate="true"
                      ValueChanged="@(s=>OnSearch(s))"
                      Placeholder="@_loc.Global("Label.Search")" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                      Class="mt-0"></MudTextField>
    </ToolBarContent>

    <HeaderContent>
        <MudTh Style="width: 30px">
            <MudCheckBox Value="@selectedAll" ValueChanged="SelectAll" T="bool"></MudCheckBox>
        </MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.CustomerCode))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.CustomerCode.Label"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.FirstName))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.FirstName.Label"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.LastName))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.LastName.Label"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.CustomerType))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.CustomerType.Label"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.LegalName))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.LegalName.Label"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.IsMember))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.IsMember.Label"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="@(nameof(CustomerViewDto.Points))" T="CustomerViewDto">@_loc[$"{LocalizerResource}.Points.Label"]</MudTableSortLabel></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudCheckBox Value="@(IsSelected(context))" ValueChanged="@((e) => SelectRecord(e, context))" T="bool"></MudCheckBox>
        </MudTd>
        <MudTd DataLabel="Code">@context.CustomerCode</MudTd>
        <MudTd DataLabel="Name">@context.FirstName</MudTd>
        <MudTd DataLabel="Name">@context.LastName</MudTd>
        <MudTd DataLabel="Name">@_loc.Enum($"{nameof(CustomerType)}.{context.CustomerType}")</MudTd>
        <MudTd DataLabel="Name">@context.LegalName</MudTd>
        <MudTd DataLabel="Name">@context.IsMember</MudTd>
        <MudTd DataLabel="Name">@context.Points</MudTd>
        <MudTd Style="width: 30px"><MudIcon @onclick="@(() => Update(context))" Icon="@Icons.Material.Filled.Edit" Class="item-show-on-hover" Size="Size.Small" /></MudTd>
    </RowTemplate>

    <NoRecordsContent>
        <MudText>@_loc.Global("Message.NoMatchingRecordsFound")</MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>@_loc.Global("Label.Loading")</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager @onchange="@Reset" RowsPerPageString="@_loc.Global($"Label.RowsPerPage")" />
    </PagerContent>
    <FooterContent>
        <MudTd colspan="5">@_loc.Global("Label.SelectedRecord"): @selectedItems.Count</MudTd>
    </FooterContent>
</MudTable>



@code {

    protected override string LocalizerResource => "CustomerPage";
    protected override string EntityName => JsonLocalizer[$"{LocalizerResource}.Entity.Name.Single"];
    protected override string EntityPluralName => JsonLocalizer[$"{LocalizerResource}.Entity.Name.Plural"];
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _state.OnChange += StateHasChanged;
        _topBarService.SetTitle(EntityPluralName);
    }

    private List<CustomerViewDto> selectedItems { get; set; } = new();
    private CancellationTokenSource cts { get; set; } = new();
    private ItemGroupDto itemGroup { get; set; } = new();
    private string[] formErrors { get; set; } = { };
    private Response? formResponse { get; set; } = null;
    private bool isFormSubmitting { get; set; }
    private AppSuccessAllert? successAllert { get; set; }
    private string? searchString = null;
    private MudTable<CustomerViewDto>? table;
    private bool selectedAll { get; set; }
    private List<CustomerViewDto> dataSource { get; set; } = new();
    private AppErrorAlert? deleteAllert { get; set; }
    private bool showFilter { get; set; }
    private List<DataGridFilterModel> filterFalues = new();
    private CustomerFilterComponent? filterComponent { get; set; }

    void OnFormKeyPress()
    {
        formResponse = null;
        _state.NotifyStateChanged();
    }

    void TogleFilter()
    {
        showFilter = !showFilter;
        if (showFilter && filterFalues.Count() == 0)
        {
            filterComponent?.AddNew();
        }
    }

    private void ClearFilter()
    {
        filterFalues = new();
        table?.ReloadServerData();
    }

    async Task Reset()
    {
        itemGroup = new();

        formResponse = null;
        isFormSubmitting = false;
        selectedItems = new();
        selectedAll = false;
        await HideAllAllert();
        _state.NotifyStateChanged();
    }

    async Task HideAllAllert()
    {
        successAllert?.HideAlert();
        deleteAllert?.HideAlert();
    }

    async Task Delete()
    {
        bool? result = await _dialogService.ShowMessageBox(DELETE, DeleteConfirmation, yesText: YES, cancelText: CANCEL, options: new DialogOptions()
        {
            FullWidth = true,
            CloseOnEscapeKey = true,
            BackdropClick = false,
        });

        if (!(result ?? false)) return;

        var ids = selectedItems.Select(x => x.Id).ToList();
        var deleteResult = await _service.Delete(new { ids = ids }, cts.Token);
        if (!deleteResult)
        {
            deleteAllert?.ShowAlert(deleteResult);
            return;
        }

        await Reset();
        table?.ReloadServerData();
        successAllert?.ShowAlert(DeleteSuccessMessage);


    }

    private void OnSearch(string text)
    {
        searchString = text;
        table?.ReloadServerData();
    }

    private async Task<TableData<CustomerViewDto>> ServerReload(TableState state, CancellationToken token)
    {
        selectedItems = new();
        selectedAll = false;
        _state.NotifyStateChanged();

        var odataFilter = new ODataFilter()
        {
            PageNumber = state.Page + 1,
            PageSize = state.PageSize,
            OrderFiled = state.SortLabel,
            SortDirection = state.SortDirection == SortDirection.None ? null : state.SortDirection.ToString(),
            FilterPayload = new { SearchKeyword = searchString, filter = filterFalues.ToFilterCondition() }
        };

        var result = await _service.Get(odataFilter, cts.Token);
        dataSource = result?.Data ?? new();

        return new TableData<CustomerViewDto>() { TotalItems = result!.Count, Items = result.Data };
    }


    async Task Update(CustomerViewDto record)
    {
        _nav.NavigateTo(PageRoutes.PostManagement.Customers.SupplierUpdate.Replace("{Id}", record.Id.ToString()));
    }

    void SelectRecord(bool selected, CustomerViewDto data)
    {
        if (!selected)
        {
            selectedAll = false;
            selectedItems = selectedItems.Where(x => x.Id != data.Id).ToList();
            return;
        }

        selectedItems.Add(data);
        UpdateSelectedAll();

    }

    void SelectAll(bool select)
    {
        selectedAll = select;
        if (!select)
        {
            selectedItems = new();
            return;
        }

        selectedItems = dataSource.ToList();
    }

    void UpdateSelectedAll()
    {
        var selectedIds = selectedItems.Select(x => x.Id);
        selectedAll = !dataSource.Where(x => !selectedIds.Contains(x.Id)).Any();
    }
    bool IsSelected(CustomerViewDto data) => selectedItems.Any(x => x.Id == data.Id);

}
