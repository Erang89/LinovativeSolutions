@using Linovative.Frontend.POSComponents.Bases
@using Linovative.Frontend.Services.Models
@using Linovative.Frontend.Shared.InputComponents.Dropdowns.SingleDropdown
@inherits POSManagementPageBase
@inject IApplicationStateService _state

@if (SKUItem is not null && Item is not null)
{
    <MudGrid Class="gap-10">
        <MudItem md="6" xl="3" xxl="2">

            <div class="d-flex" style="min-width: 150px"><MudSwitch Disabled="@(!Item.IsActive)" @bind-Value="@SKUItem.IsActive" Label="@Label("IsActive")" Color="Color.Info" /></div>
            <LinovativeGap />

            <LinovativeInputText Value="@SKUItem.SKU"
                                 ValueChanged="@((x) => { SKUItem.SKU = x; _state.NotifyStateChanged();})"
                                 Id="item_code"
                                 Immediate=true
                                 IsRequired="true"
                                 Disabled="@(!SKUItem.IsActive || !Item.IsActive)"
                                 Errors="@FormResponse?.Errors"
                                 LocalizerResource="@LocalizerResource"
                                 LocalizerKey="@(nameof(SKUItemInputDto.SKU))" />
            <LinovativeGap />


            <LinovativeInputText Value="@SKUItem.VarianName"
                                 ValueChanged="@((x) => { SKUItem.VarianName = x; _state.NotifyStateChanged(); })"
                                 Id="item_code"
                                 IsRequired="@(SKUCount > 1)"
                                 Immediate=true
                                 Disabled="@(!SKUItem.IsActive || !Item!.IsActive)"
                                 Errors="@FormResponse?.Errors"
                                 LocalizerResource="@LocalizerResource"
                                 LocalizerKey="@(nameof(SKUItemInputDto.VarianName))" />
            <LinovativeGap />


            <ItemUnitDropdown Value="@SKUItem.Unit"
                              ValueChanged="@(async (x) => { 
                                    SKUItem.Unit = x; 
                                    SKUItem.UnitId = x?.Id;
                                    _state.NotifyStateChanged(); 
                                })"
                              Id="unit"
                              Required="true"
                              Disabled="@(!SKUItem.IsActive || !Item.IsActive)"
                              Errors="@FormResponse?.Errors"
                              LocalizerResource="@LocalizerResource"
                              LocalizerKey="@nameof(SKUItemInputDto.UnitId)" />
            <LinovativeGap />


            <LinovativeInputGeneric T="decimal?"
                                    Disabled="@(!SKUItem.IsActive || !Item.IsActive || !Item.CanBeSell)"
                                    Value="@SKUItem.SalePrice"
                                    ValueChanged="@(x => SKUItem.SalePrice = x)"
                                    IsRequired="true"
                                    FullWidth="true"
                                    Errors="@FormResponse?.Errors"
                                    Style="width: 350px"
                                    LocalizerResource="@LocalizerResource"
                                    LocalizerKey="SalePrice" />

        </MudItem>


        <MudItem md="6" xl="5" xxl="4">    
            <LinovativeGap Height="38" />
            <MudSimpleTable>
                <tbody>
                    @foreach(var dto in priceTypes)
                    {
                        <tr>

                            <td style="min-width: 200px">
                                <div class="d-flex"><MudSwitch Disabled="@(!SKUItem.IsActive || !Item.IsActive || !Item.CanBeSell)" @bind-Value="@dto.Value.IsActive" Label="@dto.Key.Name" Color="Color.Info" /></div>
                            </td>


                            <td style="width: 300px">
                                <LinovativeInputGeneric Disabled="@(!SKUItem.IsActive || !dto.Value.IsActive || !Item.IsActive || !Item.CanBeSell)"
                                                    T="decimal?"
                                                    Value="@dto.Value.Price"
                                                    ValueChanged="@(x => dto.Value.Price = x)"
                                                    IsRequired="true"
                                                    FullWidth=true
                                                    Errors="@FormResponse?.Errors"
                                                    LocalizerResource="@LocalizerResource"
                                                    LocalizerKey="Price" />
                            </td>

                        </tr>
                    }
                </tbody>
            </MudSimpleTable>            
        </MudItem>

    </MudGrid>
}


@code {

    [Parameter] public ItemInputDto? Item { get; set; }
    [Parameter] public SKUItemInputDto? SKUItem { get; set; }
    [Parameter] public Response? FormResponse { get; set; } = null;
    [Parameter] public EventCallback<SKUItemInputDto> OnRemove { get; set; }
    [Parameter] public int SKUCount { get; set; }
    [Parameter] public List<PriceTypeDto> PriceTypeSources { get; set; } = new();

    protected override string LocalizerResource => nameof(ItemsPage);
    private List<KeyValuePair<PriceTypeDto, ItemPriceTypeDto>> priceTypes { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _state.OnChange += StateHasChanged;
        GenerateData();
        
    }


    async Task Remove()
    {
        await OnRemove.InvokeAsync(SKUItem);
    }


    void GenerateData()
    {
        
        Func<PriceTypeDto, ItemPriceTypeDto> getItemPriceTypeDto = (priceType) =>
        {
            var p = SKUItem?.CostumePrices.FirstOrDefault(x => x.PriceTypeId == priceType.Id);
            if (p is not null) return p;

            p = new() { SKUItemId = SKUItem?.Id, PriceTypeId = priceType.Id, IsActive = false };
            SKUItem!.CostumePrices.Add(p);
            return p;
        };

        priceTypes = PriceTypeSources.Select(x => new KeyValuePair<PriceTypeDto, ItemPriceTypeDto>(x, getItemPriceTypeDto(x))).ToList();
    }
}