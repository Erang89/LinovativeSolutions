@using LinoVative.Shared.Dto.BulkUploads
@using Linovative.Frontend.POSComponents.Bases
@using Linovative.Frontend.POSComponents.Enums
@using Linovative.Frontend.Services.BulkUploads
@using Linovative.Frontend.Services.Models
@using Linovative.Frontend.Shared.Extensions
@using Linovative.Frontend.Shared.InputComponents.FilterComponents
@using Linovative.Shared.Interface.Enums

@inherits POSManagementPageBase
@inject IApplicationStateService _state
@inject IBulkUploadItemService _bulkItem
@inject IBulkUploadItemDetailService _bulkItemDetail


@if (SelectedEntityType == BulkDataEntityTypes.ItemMaster && (
    SelectedActionTypes == BulkActionTypes.Create_Upload ||
    SelectedActionTypes == BulkActionTypes.Update_Upload))
{
    <LinovativeGap />

    <MudSimpleTable Style="overflow-x: auto;">
        <thead>
            <tr>
                <th>@(item?.headerColum1 ?? $"{Label("Column")} 1")</th>
                <th>@(item?.headerColum2 ?? $"{Label("Column")} 2")</th>
                <th>@(item?.headerColum3 ?? $"{Label("Column")} 3")</th>
                <th>@(item?.headerColum4 ?? $"{Label("Column")} 4")</th>
                <th>@(item?.headerColum5 ?? $"{Label("Column")} 5")</th>
                <th>@(item?.headerColum6 ?? $"{Label("Column")} 6")</th>
            </tr>
        </thead>
        <tbody>
            @if (details is not null)
            {
                @foreach (var row in details)
                {
                    <tr>
                        <td>@row.Column1</td>
                        <td>@row.Column2</td>
                        <td>@row.Column3</td>
                        <td>@row.Column4</td>
                        <td>@row.Column5</td>
                        <td>@row.Column6</td>
                    </tr>
                }
                <tr>
                    <td colspan="5">
                        @if (details.Count > 0)
                        {
                            <MudText>@(recordCount<pageSize? recordCount : pageSize) of @recordCount records</MudText>
                        }
                    </td>
                </tr>
            }
        </tbody>

        @if(details?.Count == 0)
        {
            <tbody>
                <tr>
                    <td colspan="6"><MudText Typo="Typo.body2">@Label("NoRecordUploaded")</MudText></td>
                </tr>
            </tbody>
        }
        <tbody>
            <tr>
                <td colspan="6">
                    <MudPagination ShowPageButtons="false" ShowFirstButton="true" ShowLastButton="true" SelectedChanged="@OnSelectedPageChanged" Count="@pageCount" />
                </td>
            </tr>
        </tbody>       
    </MudSimpleTable>


    <LinovativeGap />
    <div>
        <MudButton Disabled="@(item is null || details.Count == 0)"
                   Variant="ComponentSettings.AddNewButtonVariant"
                   StartIcon="@Icons.Material.Filled.Delete"
                   OnClick="@DeleteRecords"
                   Color="Color.Primary">@ButtonText("ClearRecord")</MudButton>
    </div>

}



@code {
    // Public Properties
    [Parameter] public BulkOperations? SelectedOperation { get; set; }
    [Parameter] public BulkDataEntityTypes? SelectedEntityType { get; set; }
    [Parameter] public BulkActionTypes? SelectedActionTypes { get; set; }
    [Parameter] public bool ShowRecord { get; set; }

    protected override string LocalizerResource => nameof(ItemBulkOperationsPage);

    // Private properties
    BulkUploadItemDto? item = new();
    List<BulkUploadItemDetailDto> details = new();
    List<DataGridFilterModel> itemFilterModels { get; set; } = new();
    CancellationTokenSource cts = new();
    int currentPage = 0;
    readonly int pageSize = 10;
    int pageCount = 0;
    int recordCount = 0;
    int itemFilterCount = 0;


    protected override async Task OnInitializedAsync()
    {
        _state.OnChange += StateHasChanged;
        await base.OnInitializedAsync();
    }


    void OnItemFilterValueChanged(List<DataGridFilterModel> fieldValues)
    {
        itemFilterModels = fieldValues;
    }

    async Task DeleteRecords()
    {
        if (item == null)
            return;

        var cts = new CancellationTokenSource();
        Func<Task<Response>>? removeFunc = SelectedActionTypes switch
        {
            BulkActionTypes.Create_Upload => () => _bulkItem.RemoveBulkCreate(cts.Token),
            BulkActionTypes.Update_Upload => () => _bulkItem.RemoveBulkUpdate(cts.Token),
            BulkActionTypes.Delete_Upload => () => _bulkItem.RemoveBulkDelete(cts.Token),
            _ => null
        };

        if (removeFunc != null)
        {
            await removeFunc!();
            Reset();
        }

        cts.Dispose();
    }


    public async Task LoadData()
    {
        cts = new();
        CrudOperations operation = SelectedOperation switch
        {
            BulkOperations.Create => CrudOperations.Create,
            BulkOperations.Update => CrudOperations.Update,
            BulkOperations.Delete => CrudOperations.Delete,
            _ => CrudOperations.Create,
        };

        var odataFilter = new ODataFilter()
        {
            PageNumber = 1,
            PageSize = 1,
            FilterPayload = new { filter = itemFilterModels.ToFilterCondition(), operation = operation }
        };

        var odataFilterDetail = new ODataFilter()
        {
            PageNumber = currentPage,
            PageSize = pageSize,
            OrderFiled = null,
            SortDirection = SortDirection.Ascending.ToString(),
            FilterPayload = new { filter = itemFilterModels.ToFilterCondition(), operation = operation }
        };
        itemFilterCount = itemFilterModels.Count;
        var task1 = _bulkItem.Get(odataFilter, cts.Token);
        var task2 = _bulkItemDetail.Get(odataFilterDetail, cts.Token);

        await Task.WhenAll(new List<Task>() { task1, task2 });

        var result = task1.Result;
        var result2 = task2.Result;

        item = result?.Data?.FirstOrDefault() ?? new();
        details = result2?.Data ?? new();

        var records = details.Count;
        var hasMod = details.Count % pageSize > 0;
        recordCount = records;
        pageCount = records == 0 ? 0 : records <= pageSize ? 1 : (records - (records % pageSize)) / pageSize + (hasMod ? 1 : 0);

        _state.NotifyStateChanged();

        cts.Dispose();
    }

    async Task OnSelectedPageChanged(int page)
    {
        currentPage = page;
        await LoadData();
    }

    void OnClearFilter()
    {
        if (itemFilterCount == 0)
            return;

        Reset();
    }

    public void Reset()
    {
        item = null;
        currentPage = 1;
        pageCount = 0;
        recordCount = 0;
    }
}
