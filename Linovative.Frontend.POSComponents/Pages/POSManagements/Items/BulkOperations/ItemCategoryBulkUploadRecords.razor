@using LinoVative.Shared.Dto.BulkUploads
@using Linovative.Frontend.POSComponents.Bases
@using Linovative.Frontend.POSComponents.Enums
@using Linovative.Frontend.Services.BulkUploads
@using Linovative.Frontend.Services.Models
@using Linovative.Frontend.Shared.Extensions
@using Linovative.Frontend.Shared.InputComponents.FilterComponents
@using Linovative.Shared.Interface.Enums

@inherits POSManagementPageBase
@inject IApplicationStateService _state
@inject IBulkOperationItemCategoryService _bulkItemCategory
@inject IBulkOperationItemCategoryDetailService _bulkItemCategoryDetail


@if (SelectedEntityType == BulkDataEntityTypes.Category && (
    SelectedActionTypes == BulkActionTypes.Create_Upload ||
    SelectedActionTypes == BulkActionTypes.Delete_Upload ||
    SelectedActionTypes == BulkActionTypes.Update_Upload))
{
    <LinovativeGap />

    <MudSimpleTable Style="overflow-x: auto;">
        <thead>
            @if (details is not null && details.Count > 0)
            {
                <tr>
                    <th>@(category?.headerColum1)</th>
                    <th>@(category?.headerColum2)</th>
                    <th>@(category?.headerColum3)</th>
                </tr>
            }
            else
            {
                <tr>
                    <th>@($"{(Label("Column"))} 1")</th>
                    <th>@($"{(Label("Column"))} 2")</th>
                    <th>@($"{(Label("Column"))} 3")</th>
                </tr>
            }
        </thead>
        <tbody>
            @if (details is not null)
            {
                @foreach (var row in details)
                {
                    <tr>
                        <td>@row.Column1</td>
                        <td>@row.Column2</td>
                        <td>@row.Column3</td>
                    </tr>
                }
                <tr>
                    <td colspan="5">
                        @if (details.Count > 0)
                        {
                            <MudText>@Lang($"{LocalizerResource}.RecordInfo.Label", details.Count, recordCount)</MudText>
                        }
                    </td>
                </tr>
            }
        </tbody>

        @if (details?.Count == 0)
        {
            <tbody>
                <tr>
                    <td colspan="6"><MudText Typo="Typo.body2">@Label("NoRecordUploaded")</MudText></td>
                </tr>
            </tbody>
        }
        <tbody>
            <tr>
                <td colspan="6">
                    <MudPagination Selected="@currentPage" ShowPageButtons="true" ShowFirstButton="true" ShowLastButton="true" SelectedChanged="@OnSelectedPageChanged" Count="@pageCount" />
                </td>
            </tr>
        </tbody>

    </MudSimpleTable>

    <LinovativeGap />
    <div>
        <MudButton Disabled="@(category is null || details.Count == 0)"
                   Variant="ComponentSettings.AddNewButtonVariant"
                   StartIcon="@Icons.Material.Filled.Delete"
                   OnClick="@DeleteRecords"
                   Color="Color.Primary">@ButtonText("ClearRecord")</MudButton>
    </div>
}



@code {
    // Public Properties
    [Parameter] public BulkOperations? SelectedOperation { get; set; }
    [Parameter] public BulkDataEntityTypes? SelectedEntityType { get; set; }
    [Parameter] public BulkActionTypes? SelectedActionTypes { get; set; }
    [Parameter] public bool ShowRecord { get; set; }

    protected override string LocalizerResource => nameof(ItemBulkOperationsPage);

    // Private properties
    BulkUploadItemCategoryDto? category = new();
    List<BulkUploadItemCategoryDetailDto> details = new();
    List<DataGridFilterModel> itemFilterModels { get; set; } = new();
    CancellationTokenSource cts = new();
    int currentPage = 1;
    int pageSize = 10;
    int pageCount = 0;
    int recordCount = 0;
    int itemFilterCount = 0;


    protected override async Task OnInitializedAsync()
    {
        _state.OnChange += StateHasChanged;
        await base.OnInitializedAsync();
    }


    void OnItemFilterValueChanged(List<DataGridFilterModel> fieldValues)
    {
        itemFilterModels = fieldValues;
    }

    async Task DeleteRecords()
    {
        if (category == null)
            return;

        var cts = new CancellationTokenSource();
        Func<Task<Response>>? removeFunc = SelectedActionTypes switch
        {
            BulkActionTypes.Create_Upload => () => _bulkItemCategory.RemoveBulkCreate(cts.Token),
            BulkActionTypes.Update_Upload => () => _bulkItemCategory.RemoveBulkUpdate(cts.Token),
            BulkActionTypes.Delete_Upload => () => _bulkItemCategory.RemoveBulkDelete(cts.Token),
            _ => null
        };

        if (removeFunc != null)
        {
            await removeFunc!();
            Reset();
        }

        cts.Dispose();
    }


    public async Task LoadData()
    {
        CrudOperations operation = SelectedOperation switch
        {
            BulkOperations.Create => CrudOperations.Create,
            BulkOperations.Update => CrudOperations.Update,
            BulkOperations.Delete => CrudOperations.Delete,
            _ => CrudOperations.Create,
        };

        var odataFilter = new ODataFilter()
        {
            PageNumber = 1,
            PageSize = 1,
            FilterPayload = new { filter = itemFilterModels.ToFilterCondition(), operation = operation }
        };

        var odataFilterDetail = new ODataFilter()
        {
            PageNumber = currentPage,
            PageSize = pageSize,
            OrderFiled = null,
            SortDirection = SortDirection.Ascending.ToString(),
            FilterPayload = new { filter = itemFilterModels.ToFilterCondition(), operation = operation }
        };
        itemFilterCount = itemFilterModels.Count;
        var task1 = _bulkItemCategory.Get(odataFilter, cts.Token);
        var task2 = _bulkItemCategoryDetail.Get(odataFilterDetail, cts.Token);

        await Task.WhenAll(new List<Task>() { task1, task2 });

        var result = task1.Result;
        var result2 = task2.Result;

        category = result?.Data?.FirstOrDefault() ?? new();
        details = result2?.Data ?? new();

        var records = result2?.Count??0;
        var hasMod = records % pageSize > 0;
        recordCount = records;
        pageCount = records == 0 ? 0 : records <= pageSize ? 1 : (records - (records % pageSize)) / pageSize + (hasMod ? 1 : 0);

        _state.NotifyStateChanged();
    }

    async Task OnSelectedPageChanged(int page)
    {
        currentPage = page;
        await LoadData();
    }

    void OnClearFilter()
    {
        if (itemFilterCount == 0)
            return;

        Reset();
    }

    public void Reset()
    {
        category = null;
        details = new();
        currentPage = 1;
        pageCount = 0;
        recordCount = 0;
    }
}
