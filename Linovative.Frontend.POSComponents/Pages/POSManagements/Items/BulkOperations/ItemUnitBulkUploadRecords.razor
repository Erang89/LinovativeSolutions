@using LinoVative.Shared.Dto.BulkUploads
@using Linovative.Frontend.POSComponents.Bases
@using Linovative.Frontend.POSComponents.Enums
@using Linovative.Frontend.POSComponents.Pages.POSManagements.Items.BulkOperations.Shared
@using Linovative.Frontend.Services.BulkUploads
@using Linovative.Frontend.Services.Models
@using Linovative.Frontend.Shared.Extensions
@using Linovative.Frontend.Shared.InputComponents.FilterComponents
@using Linovative.Shared.Interface.Enums

@inherits POSManagementPageBase
@inject IApplicationStateService _state
@inject IBulkOperationItemUnitService _bulkItemUnit
@inject IBulkOperationItemUnitDetailService _bulkItemUnitDetail


@if (SelectedEntityType == BulkDataEntityTypes.Unit && (
    SelectedActionTypes == BulkActionTypes.Update_DownloadFromDataMapping ||
    SelectedActionTypes == BulkActionTypes.Delete_DownloadFromDataMapping ||
    SelectedActionTypes == BulkActionTypes.Create_Upload ||
    SelectedActionTypes == BulkActionTypes.Delete_Upload ||
    SelectedActionTypes == BulkActionTypes.Update_Upload))
{
    <LinovativeGap />

    <MudSimpleTable Style="overflow-x: auto;">
        <thead>
            @if (details is not null && details.Count > 0)
            {
                <tr>
                    <th style="width: 315px;">@(unit?.headerColum1)</th>
                    <th>@(unit?.headerColum2)</th>
                </tr>
            }
            else
            {
                <tr>
                    <th>A</th>
                    <th>B</th>
                </tr>
            }
        </thead>
        <tbody>
            @if (details is not null)
            {
                @foreach (var row in details)
                {
                    <tr>
                        <td>@row.Column1</td>
                        <td>@row.Column2</td>
                    </tr>
                }
                <tr>
                    <td colspan="5">
                        @if (details.Count > 0)
                        {
                            <div class="d-flex">
                                <div style="width: 200px" class="mr-2"><MudText>@Lang($"{LocalizerResource}.RecordInfo.Label", details.Count, recordCount)</MudText></div>
                                <div style="width: 100%">
                                    <MudButton Disabled="@(unit is null || details.Count == 0)"
                                               Variant="ComponentSettings.AddNewButtonVariant"
                                               StartIcon="@Icons.Material.Filled.Delete"
                                               OnClick="@DeleteRecords"
                                               Color="Color.Primary">@ButtonText("ClearRecord")</MudButton>

                                    <MudButton Disabled="@(saveResult is null || details.Count == 0 || saveResult)"
                                               Variant="ComponentSettings.AddNewButtonVariant"
                                               StartIcon="@Icons.Material.Filled.Download"
                                               Class="ms-2"
                                               OnClick="@DownloadError"
                                               Color="Color.Warning">@ButtonText("DownloadErrorLog")</MudButton>
                                </div>
                            </div>

                        }
                    </td>
                </tr>
            }
        </tbody>

        @if (details?.Count == 0)
        {
            <tbody>
                <tr>
                    <td colspan="6"><MudText Typo="Typo.body2">@Label("NoRecordUploaded")</MudText></td>
                </tr>
            </tbody>
        }
        <tbody>
            <tr>
                <td colspan="6">
                    <MudPagination Selected="@currentPage" ShowPageButtons="true" ShowFirstButton="true" ShowLastButton="true" SelectedChanged="@OnSelectedPageChanged" Count="@pageCount" />
                </td>
            </tr>
        </tbody>

    </MudSimpleTable>


    @if (unit is not null && details.Count > 0)
    {
        <LinovativeGap />
        <MudText Typo="Typo.caption">@Label("MappingUnitFields")</MudText>
        <UnitFieldMappings @ref="@MappingFieldUI" Operations="@SelectedOperation"
                           RequiredFields="@RequiredFields"
                           FieldMappingChanged="@((mapping) => FieldMapping = mapping)"
                           RequiredFieldMappingChanged="@((x) => RequiredFieldsHasMapped = x)"
                           Columns="@unit" />
    }

    <LinovativeGap />
    <AppErrorAlert AutoClose="true" @ref="@formErrorAlert" />

    <MudButton Disabled="@(!RequiredFieldsHasMapped || !AnyUpdatingFieldSelected || details.Count == 0)"
               Variant="ComponentSettings.AddNewButtonVariant"
               StartIcon="@Icons.Material.Filled.Save"
               OnClick="@Save"
               Color="Color.Primary">@ButtonText("Save")</MudButton>
}



@code {
    // Public Properties
    [Parameter] public BulkOperations? SelectedOperation { get; set; }
    [Parameter] public BulkDataEntityTypes? SelectedEntityType { get; set; }
    [Parameter] public BulkActionTypes? SelectedActionTypes { get; set; }
    [Parameter] public EventCallback<Response?> SaveResponseChanged { get; set; }
    [Parameter] public EventCallback OnSubmiting { get; set; }

    [Parameter] public bool ShowRecord { get; set; }

    protected override string LocalizerResource => nameof(ItemBulkOperationsPage);

    // Private properties
    BulkUploadItemUnitDto? unit = new();
    List<BulkUploadItemUnitDetailDto> details = new();
    List<DataGridFilterModel> itemFilterModels { get; set; } = new();
    CancellationTokenSource cts = new();
    int currentPage = 1;
    readonly int pageSize = 10;
    int pageCount = 0;
    int recordCount = 0;
    int itemFilterCount = 0;
    bool RequiredFieldsHasMapped = false;
    IDictionary<string, string> FieldMapping = new Dictionary<string, string>();
    bool AnyUpdatingFieldSelected => SelectedOperation is not BulkOperations.Update || FieldMapping.Any(x => x.Key != "Id");
    UnitFieldMappings? MappingFieldUI;
    AppErrorAlert? formErrorAlert;
    Response? saveResult;

    protected override async Task OnInitializedAsync()
    {
        _state.OnChange += StateHasChanged;
        await base.OnInitializedAsync();
    }


    void OnItemFilterValueChanged(List<DataGridFilterModel> fieldValues)
    {
        itemFilterModels = fieldValues;
    }

    async Task DeleteRecords()
    {
        if (unit == null)
            return;

        var cts = new CancellationTokenSource();
        await _bulkItemUnit.Remove(SelectedOperation.ToCrudOperations(SelectedActionTypes), cts.Token);
        Reset();
        cts.Dispose();
    }


    async Task Save()
    {
        cts = new();
        var type = SelectedOperation switch
        {
            BulkOperations.Create => CrudOperations.Create,
            BulkOperations.Update => CrudOperations.Update,
            BulkOperations.Delete => CrudOperations.Delete,
            _ => CrudOperations.Update,
        };
        await OnSubmiting.InvokeAsync();
        var result = await _bulkItemUnit.Save(type, FieldMapping, cts.Token);
        saveResult = result;

        if (result)
        {
            unit = null;
            details = new();
            await MappingFieldUI!.Reset();
            FieldMapping.Clear();
        }
        if (!result) formErrorAlert?.ShowAlert(result);
        await SaveResponseChanged.InvokeAsync(result);
        cts.Dispose();
    }


    public async Task LoadData()
    {
        var operation = SelectedOperation.ToCrudOperations(SelectedActionTypes);

        var odataFilter = new ODataFilter()
        {
            PageNumber = 1,
            PageSize = 1,
            FilterPayload = new { filter = itemFilterModels.ToFilterCondition(), operation = operation }
        };

        var odataFilterDetail = new ODataFilter()
        {
            PageNumber = currentPage,
            PageSize = pageSize,
            OrderFiled = null,
            SortDirection = SortDirection.Ascending.ToString(),
            FilterPayload = new { filter = itemFilterModels.ToFilterCondition(), operation = operation }
        };
        itemFilterCount = itemFilterModels.Count;
        var task1 = _bulkItemUnit.Get(odataFilter, cts.Token);
        var task2 = _bulkItemUnitDetail.Get(odataFilterDetail, cts.Token);

        await Task.WhenAll(new List<Task>() { task1, task2 });

        var result = task1.Result;
        var result2 = task2.Result;

        unit = result?.Data?.FirstOrDefault() ?? new();
        details = result2?.Data ?? new();

        var records = result2?.Count ?? 0;
        var hasMod = records % pageSize > 0;
        recordCount = records;
        pageCount = records == 0 ? 0 : records <= pageSize ? 1 : (records - (records % pageSize)) / pageSize + (hasMod ? 1 : 0);

        _state.NotifyStateChanged();
    }

    async Task OnSelectedPageChanged(int page)
    {
        currentPage = page;
        await LoadData();
    }

    void OnClearFilter()
    {
        if (itemFilterCount == 0)
            return;

        Reset();
    }

    public void Reset()
    {
        unit = null;
        details = new();
        currentPage = 1;
        pageCount = 0;
        recordCount = 0;
    }

    List<string> RequiredFields => SelectedOperation is BulkOperations.Create ?
         new List<string>() { "Name" } :
         new List<string>() { "Id" };

    async Task DownloadError()
    {
        var crudOperation = SelectedOperation switch
        {
            BulkOperations.Create => CrudOperations.Create,
            BulkOperations.Update => CrudOperations.Update,
            BulkOperations.Delete => CrudOperations.Delete,
            _ => throw new NotImplementedException()
        };
        await _bulkItemUnit.DownloadErrorFile(crudOperation);
    }
}
